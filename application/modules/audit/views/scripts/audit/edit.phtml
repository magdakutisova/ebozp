<?php 
echo $this->formHidden("auditId", $this->audit->id);
echo $this->formHidden("clientId", $this->client->id_client);
?>
<?php echo $this->auditInfo()->header($this->audit, $this->client, $this->subsidiary); ?>
<div id="tabs">
	<ul>
		<li><a href="#overview">Přehled</a></li>
		<li><a href="#forms">Formuláře</a></li>
		<li><a href="#mistakes">Neshody</a></li>
		<li><a href="#newmistake">Neshody z pracovišť</a></li>
		<li><a href="#workcomments">Kontrola pracovišť</a></li>
	</ul>
	<div id="overview" class="tab">
		<h3>Přehled</h3>
		<?php
		echo $this->form;
		?>
		<em>*)Shrnutí musí být vyplněno než bude audit/prověrka uzavřena a odeslána koordinátorovi</em>
		<?php 
		// vyhodnoceni zobrazeni uzavreni auditu
		if ($this->form->getElement("summary")->getValue()) {
			?>
		<h3>Uzavření auditu</h3>
			<?php 
			echo $this->submitForm;
		}
		?>
	</div>
	<div id="forms" class="tab">
		<h3>Formuláře</h3>
		<table>
			<thead>
				<tr>
					<th>
					Formulář
					</th>
					<th>
					Skóre
					</th>
				</tr>
			</thead>
			<tbody>
		<?php 
		$params = array(
				"clientId" => $this->client->id_client,
				"subsidiaryId" => $this->subsidiary->id_subsidiary,
				"auditId" => $this->audit->id
		);
		
		foreach ($this->formInstances as $instance) {
			$params["formId"] = $instance->id;
			
			$href = $this->url($params, "audit-form-fill");
			
			?>
				<tr>
					<td>
					<a href="<?php echo $href; ?>"><?php echo $instance->name; ?></a>
					</td>
					<td>
					<?php echo $instance->score; ?>
					</td>
				</tr>
			<?php 
		}
		?>
			</tbody>
		</table>
		<?php echo $this->instanceForm; ?>
	</div>
	<div id="mistakes" class="tab">
		<h3>Neshody zahrnuté v <?php echo $this->audit->is_check ? "prověrce" : "auditu"; ?></h3>
		<form action="<?php echo $this->url(array("auditId" => $this->audit->id, "clientId" => $this->audit->client_id), "audit-mistake-detach"); ?>" method="post">
		<table id="table-mistakes" class="multirow-table">
			<?php 
			$this->mistakeTable()->workIndex = $this->workIndex;
			
			echo $this->mistakeTable()->header();
			
			foreach ($this->mistakes[0] as $mistake) {
				// vyhodnoceni semaforu
				$assoc = $this->assocIndex[$mistake->id];
				$semaphore = $assoc->status;
				$selector = $mistake->audit_id != $this->audit->id;
				
				echo $this->mistakeTable()->mistake($mistake, array("actions" => array("edit-mistake" => "Upravit"), "semaphore" => $semaphore, "selector" => $selector));
			}
			?>
		</table>
		<p>
			<?php 
			echo $this->formButton("save-mistakes", "Uložit semafory"); 
			echo $this->formSubmit("submit-detach", "Odebrat označené neshody z auditu");
			?>
		</p>
		</form>
		<h3>Neshody z jinch auditů a prověrek</h3>
		<form action="<?php echo $this->url(array("auditId" => $this->audit->id, "clientId" => $this->audit->client_id), "audit-mistake-attach"); ?>" method="post">
			<table id="table-mistakes2" class="multirow-table">
				<?php 
				$this->mistakeTable()->workIndex = $this->workIndex;
				
				echo $this->mistakeTable()->header();
				
				foreach ($this->mistakes[1] as $mistake) {
					// vyhodnoceni semaforu
					
					echo $this->mistakeTable()->mistake($mistake, array("actions" => array("show" => "Zobrazit"), "selector" => true));
				}
				?>
			</table>
			<p>
			<?php echo $this->formSubmit("attach-submit", "Připojit označené neshody k auditu"); ?>
			</p>
		</form>
	</div>
	<div id="newmistake">
	<?php 
	echo $this->selectWorkplace;
	?>
	</div>
	<div id="workcomments">
		<?php echo $this->action("get", "workplace", "audit", array("auditId" => $this->audit)); ?>
	</div>
</div>
<script type="text/javascript" src="/js/audit/audit/edit.js"></script>