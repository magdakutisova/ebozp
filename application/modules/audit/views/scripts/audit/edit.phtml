<?php 
echo $this->formHidden("auditId", $this->audit->id);
echo $this->formHidden("clientId", $this->client->id_client);
echo $this->formHidden("client_id", $this->client->id_client);
?>
<?php echo $this->auditInfo()->header($this->audit, $this->client, $this->subsidiary); ?>
<div id="tabs">
	<ul>
		<li><a href="#overview">Přehled</a></li>
		<li><a href="#forms">Formuláře</a></li>
		<li><a href="#mistakes">Neshody</a></li>
		<li><a href="#workcomments">Kontrola pracovišť</a></li>
		<li><a href="#newworkplace">Nové pracoviště</a></li>
		<li><a href="#newmistake">Jiná neshoda</a></li>
	</ul>
	<div id="overview" class="tab">
		<h3>Přehled</h3>
		<?php
		echo $this->form;
		
		// vyhodnoceni zobrazeni uzavreni auditu
		$audit = $this->audit;
		$userId = $this->userId;
		
		// vyhodnoceni, jestli je zprava vygenerovana
		if ($audit->report_id) {
			// tady bude odkaz na editaci zpravy
			echo "<fieldset><legend>Závěrečná zpráva</legend>";
			
			$url = $this->url(array("clientId" => $audit->client_id, "auditId" => $audit->id), "audit-report-edit");
			echo "<a href='$url'>Výstupní zpráva z auditu</a>";
			
			echo "</fieldset>";
		} else {
			// odkaz na vytvoreni zpravy
			$url = $this->url(array("clientId" => $audit->client_id, "auditId" => $audit->id), "audit-report-create");
			
			echo "<p><big><strong>Zpráva ještě není vytvořena</strong> <a href='$url'>Vytvořit zprávu</a></big></p>";
		}
		
		$isReport = $userId == $audit->auditor_id && $audit->report_id;
		
		echo "<div id='other-contact-person'>";
		echo "<h2>Jiná kontaktní osoba</h2>";
		echo $this->contactForm;
		echo "</div>";
		
		if ($isReport) {
			?>
		<h3>Uzavření auditu</h3>
			<?php 
			echo $this->submitForm;
		}
		?>
	</div>
	<div id="forms" class="tab">
		<h3>Formuláře</h3>
		<table>
			<thead>
				<tr>
					<th>
					Formulář
					</th>
				</tr>
			</thead>
			<tbody>
		<?php 
		$params = array(
				"clientId" => $this->client->id_client,
				"subsidiaryId" => $this->subsidiary->id_subsidiary,
				"auditId" => $this->audit->id
		);
		
		foreach ($this->formInstances as $instance) {
			$params["formId"] = $instance->id;
			
			$href = $this->url($params, "audit-form-fill");
			
			?>
				<tr>
					<td>
					<a href="<?php echo $href; ?>"><?php echo $instance->name; ?></a>
					</td>
				</tr>
			<?php 
		}
		?>
			</tbody>
		</table>
		<?php echo $this->instanceForm; ?>
	</div>
	<div id="mistakes" class="tab">
		<h3>Neshody zahrnuté v <?php echo $this->audit->is_check ? "prověrce" : "auditu"; ?></h3>
		<form action="<?php echo $this->url(array("auditId" => $this->audit->id, "clientId" => $this->audit->client_id), "audit-mistake-detach"); ?>" method="post">
		<table id="table-mistakes" class="multirow-table">
			<?php 
			$this->mistakeTable()->workIndex = $this->workIndex;
			
			echo $this->mistakeTable()->header();
			
			foreach ($this->auditMistakes as $mistake) {
				// vyhodnoceni semaforu
				$selector = $mistake->audit_id != $this->audit->id;
				$assoc = $this->mistakeAssocIndex[$mistake->id];
				
				$classes = array();
				
				// vyhodnoceni barvy
				if ($assoc->status == 2) {
					$classes = array("mistake-removed");
				} elseif ($mistake->is_marked) {
					$classes = array("mistake-marked");
				}
				
				// vyhodnoceni akci
				if ($mistake->audit_id == $this->audit->id) {
					// jedna se o neshodu pochazejici z tohoto auditu
					$actions = array("edit-mistake" => "Upravit");
				} else {
					$actions = array("get-mistake" => "Zobrazit");
				}
				
				echo $this->mistakeTable()->mistake($mistake, array("classes" => $classes, "actions" => $actions, "selector" => $selector));
			}
			?>
		</table>
		<p>
			<?php 
			echo $this->formSubmit("submit-solve", "Označit jako odstraněné");
			echo $this->formSubmit("submit-unsolve", "Označit jako NEodstraněné");
			?>
		</p>
		</form>
	</div>
	<div id="newmistake">
	<?php 
	echo $this->selectWorkplace;
	?>
	</div>
	<div id="newworkplace">
		<div id="new-workplace-form">
			<?php echo $this->placeForm; ?>
		</div>
	</div>
	<div id="workcomments">
		<?php echo $this->action("get", "workplace", "audit", array("auditId" => $this->audit)); ?>
	</div>
</div>

<div class="multiCheckboxWorkplaces"></div>

<div class="hidden" id="new_position_form">
	<?php echo $this->postForm; ?>
</div>
<div class="hidden" id="new_work_form">
	<?php echo $this->workForm; ?>
</div>
<div class="hidden" id="new_chemical_form">
	<?php echo $this->chemForm; ?>
</div>
<div class="hidden" id="new_technicaldevice_form">
	<?php echo $this->techForm; ?>
</div>
<div class="hidden" id="new_folder_form">
	<?php echo $this->folderForm; ?>
</div>
<script type="text/javascript" src="/js/audit/audit/edit.js"></script>